<!DOCTYPE html>
<html>
<head>
<script src="jquery.min.js"></script>
<script src="ejs.min.js"></script>
</head>
<body>
<div id="output"></div>

<script>
const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
const oneWeek = oneDay * 7;
const oneMonth = oneDay * 30;

var generate = (json, template) => {
    var extensions = {};
    json.rows.forEach((it) => {
        var extension = extensions[it.id];
        if (! extension) {
            extension = extensions[it.id] = {
                title: it.title,    
                downloads: it.downloads,
                type: it.type, 
                createdOn: new Date(it.created),
                analyzer: it.analyzer, 
                provider: it.author
            };
        }

        // Save some properties for the latest version only
        if (it.absoluteLatest) {
            extension.version = it.version;
            extension.description = it.description;
            extension.publishedOn = new Date(it.published);
            extension.iconurl = it.iconurl;
        }
        
        // createdOn is the oldest date
        if (it.created && extension.createdOn > new Date(it.created)) {
            extension.createdOn = new Date(it.created);
        }
    });

    var addedLast30days = () => {
        var arr = Object.keys(extensions).reduce(
            (acc, it) => {
                var extension = extensions[it];
                if (((new Date()).getTime() - extension.createdOn.getTime()) < oneMonth)
                    acc.push({title: extension.title, 
                              version: extension.version, 
                              date: extension.publishedOn, 
                              age: getDuration (extension.publishedOn, new Date()),
                              id:it, 
                              downloads: extension.downloads, 
                              provider:extension.provider,
                              iconurl: extension.iconurl});
                return acc;
            }, []);
         arr = arr.sort((it1, it2) => it2.date - it1.date);
        return arr; 
    }
    
    var upgradedLast30days = () => {
        var arr = Object.keys(extensions).reduce(
            (acc, it) => {
                var extension = extensions[it];    
                if (((new Date()).getTime() - extension.createdOn.getTime()) > oneMonth &&
                    ((new Date()).getTime() - extension.publishedOn.getTime()) < oneMonth)
                    acc.push({title: extension.title, 
                              version: extension.version, 
                              date: extension.publishedOn, 
                              age: getDuration (extension.publishedOn, new Date()),
                              id:it, 
                              downloads: extension.downloads, 
                              description: extension.description,
                              provider:extension.provider,                              
                              iconurl: extension.iconurl});
                return acc;
            }, []);
         arr = arr.sort((it1, it2) => it2.date - it1.date);
        return arr; 
    }

    var recentExtensions ={
        added: addedLast30days(),
        upgraded: upgradedLast30days(),        
    };
    return  ejs.render(template, {recentExtensions: recentExtensions}, null);
}

// This script is released to the public domain and may be used, modified and
// distributed without restrictions. Attribution not necessary but appreciated.
// Source: https://weeknumber.net/how-to/javascript

// Returns the ISO week of the date.
Date.prototype.getWeek = function() {
  var date = new Date(this.getTime());
  date.setHours(0, 0, 0, 0);
  // Thursday in current week decides the year.
  date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
  // January 4 is always in week 1.
  var week1 = new Date(date.getFullYear(), 0, 4);
  // Adjust to Thursday in week 1 and count number of weeks from date to week1.
  return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000
                        - 3 + (week1.getDay() + 6) % 7) / 7);
}

var getDuration = (before, after) => {
        let days = Math.round(((new Date(after).setHours(0,0,0,0)) - (new Date(before).setHours(0,0,0,0))) / (24*60*60*1000));
        let weeks = after.getWeek() - before.getWeek();

        if (days === 0)
            return "today";

        if (days === 1)
            return "yesterday";

        if (days < 4)
            return days + " days ago";
            
        if (weeks === 0) 
           return "this week";
           
        if (weeks === 1) 
           return "last week";
        
        return weeks + " weeks ago";
}

var render = (json, template) => {
    var html = generate(json[0], template[0]);
    $('#output').html(html);
}

var unavailable = (e) => {
    console.log(e);
    alert("Service unavailable");
}

$.when( $.ajax( "https://extendng.castsoftware.com/api/package" ), $.ajax( "template.html" ) )
  .then( render, unavailable );

</script> 
</body>