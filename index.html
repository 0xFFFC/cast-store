<html>
<head>
<script src="jquery.min.js"></script>
<script src="ejs.min.js"></script>
</head>
<body>
<div id="output"></div>

<script>
const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
const oneWeek = oneDay * 7;
const oneMonth = oneDay * 30;

var generate = (json, template) => {
    var extensions = {};
    json.rows.forEach((it) => {
        
        // Not yet public !
        if (it.id == "com.castsoftware.carlcli") return;
        var extension = extensions[it.id];
        if (! extension) {
            extension = extensions[it.id] = {
                title: it.title,    
                downloads: it.downloads,
                type: it.type, 
                createdOn: new Date(it.created),
                analyzer: it.analyzer, 
                provider: it.author
            };
        }

        // Save some properties for the latest version only
        if (it.absoluteLatest) {
            extension.version = it.version;
            extension.description = it.description;
            extension.publishedOn = new Date(it.published);
            extension.iconurl = it.iconurl;
        }
        
        // createdOn is the oldest date
        if (it.created && extension.createdOn > new Date(it.created)) {
            extension.createdOn = new Date(it.created);
        }
    });

    var addedLast30days = () => {
        var arr = Object.keys(extensions).reduce(
            (acc, it) => {
                var extension = extensions[it];
                if (((new Date()).getTime() - extension.createdOn.getTime()) < oneMonth)
                    acc.push({title: extension.title, 
                              version: extension.version, 
                              date: extension.publishedOn, 
                              id:it, 
                              downloads: extension.downloads, 
                              provider:extension.provider,
                              iconurl: extension.iconurl});
                return acc;
            }, []);
         arr = arr.sort((it1, it2) => it2.date - it1.date);
        return arr; 
    }
    
    var upgradedLast30days = () => {
        var arr = Object.keys(extensions).reduce(
            (acc, it) => {
                var extension = extensions[it];    
                if (((new Date()).getTime() - extension.createdOn.getTime()) > oneMonth &&
                    ((new Date()).getTime() - extension.publishedOn.getTime()) < oneMonth)
                    acc.push({title: extension.title, 
                              version: extension.version, 
                              date: extension.publishedOn, 
                              id:it, 
                              downloads: extension.downloads, 
                              description: extension.description,
                              provider:extension.provider,                              
                              iconurl: extension.iconurl});
                return acc;
            }, []);
         arr = arr.sort((it1, it2) => it2.date - it1.date);
        return arr; 
    }

    var recentExtensions ={
        added: addedLast30days(),
        upgraded: upgradedLast30days(),        
    };
    return  ejs.render(template, {recentExtensions: recentExtensions}, null);
}


var render = (json, template) => {
    var html = generate(json[0], template[0]);
    $('#output').html(html);
}

var unavailable = (e) => {
    console.log(e);
    alert("Service unavailable");
}

$.when( $.ajax( "https://extendng.castsoftware.com/api/package" ), $.ajax( "template.html" ) )
  .then( render, unavailable );

</script> 
</body>