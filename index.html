<!DOCTYPE html>
<html>
<head>
<script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
<script src="https://npmcdn.com/ejs@3.0.2/ejs.min.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-42547942-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-42547942-5');
</script>


<style>
body { background-color: #eee;}

@keyframes spinner {
  to {transform: rotate(360deg);}
}
 
.spinner:before {
  content: '';
  box-sizing: border-box;
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin-top: -10px;
  margin-left: -10px;
  border-radius: 50%;
  border: 2px solid #ccc;
  border-top-color: #000;
  animation: spinner .6s linear infinite;
}
</style>
</head>
<body>
<div id="spinner" class="spinner"></div>
<div id="output"></div>

<script>
const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
const oneMonth = oneDay * 30;

var collect = (json) => {
    var extensions = {};
    json.rows.forEach((it) => {
        if (! it.listed) return;
        var extension = extensions[it.id];
        if (! extension) {
            extension = extensions[it.id] = {
                id: it.id,
                title: it.title,    
                downloads: it.downloads,
                type: it.type, 
                createdOn: new Date(it.created),
                analyzer: it.analyzer, 
                provider: it.author
            };
        }

        // Save some properties for the latest version only
        if (it.absoluteLatest) {
            extension.version = it.version;
            extension.description = it.description;
            extension.date = extension.publishedOn = new Date(it.published);
            extension.age = getDuration (extension.publishedOn, new Date());            
            extension.iconurl = it.iconurl;
        }
        
        // createdOn is the oldest date
        if (it.created && extension.createdOn > new Date(it.created)) {
            extension.createdOn = new Date(it.created);
        }
    });

    var addedLast30days = () => {
        var arr = Object.keys(extensions).reduce(
            (acc, it) => {
                var extension = extensions[it];
                if (((new Date()).getTime() - extension.createdOn.getTime()) < oneMonth) 
                    acc.push(extension);
                return acc;
            }, []);
         arr = arr.sort((it1, it2) => it2.date - it1.date);
        return arr; 
    }
    
    var upgradedLast30days = () => {
        var arr = Object.keys(extensions).reduce(
            (acc, it) => {
                var extension = extensions[it];    
                if (((new Date()).getTime() - extension.createdOn.getTime()) > oneMonth &&
                    ((new Date()).getTime() - extension.publishedOn.getTime()) < oneMonth)
                        acc.push(extension);
                return acc;
            }, []);
         arr = arr.sort((it1, it2) => it2.date - it1.date);
        return arr; 
    }

    var recentExtensions = {
        added: addedLast30days(),
        upgraded: upgradedLast30days(),        
    };
    
    return recentExtensions;
}

// This script is released to the public domain and may be used, modified and
// distributed without restrictions. Attribution not necessary but appreciated.
// Source: https://weeknumber.net/how-to/javascript
// Returns the ISO week of the date.
Date.prototype.getWeek = function() {
  var date = new Date(this.getTime());
  date.setHours(0, 0, 0, 0);
  // Thursday in current week decides the year.
  date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
  // January 4 is always in week 1.
  var week1 = new Date(date.getFullYear(), 0, 4);
  // Adjust to Thursday in week 1 and count number of weeks from date to week1.
  return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000
                        - 3 + (week1.getDay() + 6) % 7) / 7);
}

var getDuration = (before, after) => {
        let days = Math.round(((new Date(after).setHours(0,0,0,0)) - (new Date(before).setHours(0,0,0,0))) / (24*60*60*1000));
        let weeks = after.getWeek() - before.getWeek();

        if (days === 0)
            return "today";

        if (days === 1)
            return "yesterday";

        if (days < 4)
            return days + " days ago";
            
        if (weeks === 0) 
           return "this week";
           
        if (weeks === 1) 
           return "last week";
        
        return weeks + " weeks ago";
}

var render = (json, template) => {
    $('#spinner').removeClass('spinner');
    var recentExtensions = collect(json[0]);
    var html = ejs.render(template[0], {recentExtensions: recentExtensions}, null);    
    $('#output').html(html);
}

var unavailable = (e) => {
    $('#spinner').removeClass('spinner');
    $('#output').html('Service not available, please check <a href="https://extendng.castsoftware.com">https://extendng.castsoftware.com</a>');
}

$.when( $.ajax( "https://extendng.castsoftware.com/api/package" ), $.ajax( "template.html" ) )
  .then( render, unavailable );

</script> 
</body>